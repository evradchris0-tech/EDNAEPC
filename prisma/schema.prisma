// Schema Prisma pour Church Management System
// Base de données: PostgreSQL (Neon)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ═══════════════════════════════════════════════════════════════════════════
// AUTHENTIFICATION (Auth.js / NextAuth)
// ═══════════════════════════════════════════════════════════════════════════

enum Role {
  SUPER_ADMIN
  ADMIN
  GESTIONNAIRE
  TRESORIER
  SECRETAIRE
}

model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  emailVerified DateTime?
  password      String?
  image         String?
  role          Role      @default(SECRETAIRE)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations Auth.js
  accounts Account[]
  sessions Session[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ═══════════════════════════════════════════════════════════════════════════
// PAROISSIENS (Membres de l'église)
// ═══════════════════════════════════════════════════════════════════════════

enum Genre {
  HOMME
  FEMME
}

enum Categorie {
  ANCIEN
  DIACRE
  FIDELE
}

enum SituationMatrimoniale {
  CELIBATAIRE
  MARIE
  VEUF
  DIVORCE
}

model Paroissien {
  id            String    @id @default(cuid())
  matricule     String    @unique
  newMatricule  String?   @unique

  // Informations personnelles
  name          String
  genre         Genre     @default(HOMME)
  birthdate     DateTime?
  birthplace    String?

  // Contact
  email         String?
  phone         String?
  address       String?   @db.Text

  // Informations ecclésiales
  categorie     Categorie @default(FIDELE)
  situation     SituationMatrimoniale @default(CELIBATAIRE)
  schoolLevel   String?
  servicePlace  String?   // Lieu de service (pour Anciens/Diacres)

  // Dates importantes
  baptiseDate   DateTime?
  confirmDate   DateTime?
  adhesionDate  DateTime?

  // Métadonnées
  notes         String?   @db.Text
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  associations  AssociationParoissien[]
  engagements   Engagement[]
  versements    Versement[]
  cotisations   Cotisation[]

  @@index([name])
  @@index([categorie])
  @@index([isActive])
  @@map("paroissiens")
}

// ═══════════════════════════════════════════════════════════════════════════
// ASSOCIATIONS (Ministères / Groupes)
// ═══════════════════════════════════════════════════════════════════════════

model Association {
  id        String   @id @default(cuid())
  name      String   @unique
  sigle     String?  @unique

  // Métadonnées
  description String? @db.Text
  isActive    Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  paroissiens AssociationParoissien[]
  offrandes   Offrande[]

  @@map("associations")
}

// Table pivot Paroissien <-> Association avec métadonnées
model AssociationParoissien {
  id            String   @id @default(cuid())
  paroissienId  String
  associationId String

  isPrimary     Boolean  @default(false) // Association principale
  dateAdhesion  DateTime @default(now())
  statut        String?  // Membre, Responsable, etc.
  notes         String?  @db.Text

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  paroissien  Paroissien  @relation(fields: [paroissienId], references: [id], onDelete: Cascade)
  association Association @relation(fields: [associationId], references: [id], onDelete: Cascade)

  @@unique([paroissienId, associationId])
  @@index([associationId])
  @@map("association_paroissien")
}

// ═══════════════════════════════════════════════════════════════════════════
// FINANCES - ENGAGEMENTS
// ═══════════════════════════════════════════════════════════════════════════

model Engagement {
  id           String   @id @default(cuid())
  paroissienId String

  // Montants engagés (promis)
  dime              Decimal @default(0) @db.Decimal(12, 2)
  cotisation        Decimal @default(0) @db.Decimal(12, 2)
  detteDime         Decimal @default(0) @db.Decimal(12, 2)
  detteCotisation   Decimal @default(0) @db.Decimal(12, 2)

  // Montants reçus (disponibles)
  availableDime           Decimal @default(0) @db.Decimal(12, 2)
  availableCotisation     Decimal @default(0) @db.Decimal(12, 2)
  availableDetteDime      Decimal @default(0) @db.Decimal(12, 2)
  availableDetteCotisation Decimal @default(0) @db.Decimal(12, 2)

  // Période
  periodeStart DateTime
  periodeEnd   DateTime

  // Métadonnées
  notes     String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  paroissien Paroissien  @relation(fields: [paroissienId], references: [id], onDelete: Cascade)
  versements Versement[]

  @@index([paroissienId])
  @@index([periodeStart, periodeEnd])
  @@map("engagements")
}

// ═══════════════════════════════════════════════════════════════════════════
// FINANCES - VERSEMENTS
// ═══════════════════════════════════════════════════════════════════════════

enum TypeVersement {
  DIME
  DETTE_DIME
  DETTE_COTISATION
  OFFRANDE_CONSTRUCTION
}

model Versement {
  id            String        @id @default(cuid())
  paroissienId  String
  engagementId  String?

  type          TypeVersement
  somme         Decimal       @db.Decimal(12, 2)
  dateVersement DateTime      @default(now())

  // Métadonnées
  reference     String?       // Numéro de reçu
  notes         String?       @db.Text
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  paroissien Paroissien  @relation(fields: [paroissienId], references: [id], onDelete: Cascade)
  engagement Engagement? @relation(fields: [engagementId], references: [id], onDelete: SetNull)

  @@index([paroissienId])
  @@index([engagementId])
  @@index([dateVersement])
  @@index([type])
  @@map("versements")
}

// ═══════════════════════════════════════════════════════════════════════════
// FINANCES - COTISATIONS SPÉCIALES
// ═══════════════════════════════════════════════════════════════════════════

enum TypeCotisation {
  RECOLTE
  AUTRES_RECETTES
}

model Cotisation {
  id           String         @id @default(cuid())
  paroissienId String

  type         TypeCotisation
  somme        Decimal        @db.Decimal(12, 2)
  forYear      Int            // Année concernée

  // Métadonnées
  description  String?
  datePaiement DateTime       @default(now())
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  // Relations
  paroissien Paroissien @relation(fields: [paroissienId], references: [id], onDelete: Cascade)

  @@index([paroissienId])
  @@index([forYear])
  @@index([type])
  @@map("cotisations")
}

// ═══════════════════════════════════════════════════════════════════════════
// FINANCES - OFFRANDES DES ASSOCIATIONS
// ═══════════════════════════════════════════════════════════════════════════

model Offrande {
  id            String   @id @default(cuid())
  associationId String

  somme         Decimal  @db.Decimal(12, 2)
  offrandeDay   DateTime
  description   String?

  // Métadonnées
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  association Association @relation(fields: [associationId], references: [id], onDelete: Cascade)

  @@index([associationId])
  @@index([offrandeDay])
  @@map("offrandes")
}
